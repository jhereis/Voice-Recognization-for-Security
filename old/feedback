import sounddevice as sd
from scipy.io.wavfile import write
import librosa
import numpy as np
import tensorflow as tf
import uuid
import os
import csv
from ibm_watson import SpeechToTextV1
from ibm_cloud_sdk_core.authenticators import IAMAuthenticator

# ğŸ“Œ ConfiguraÃ§Ãµes do IBM Watson
API_KEY = 0GwP85CeCaKSUde
URL = https://api.au-syd.speech-to-text.watson.cloud.ibm.com/instances/cf7b-4cf3-babd-cb0e4f8ea11f

authenticator = IAMAuthenticator(API_KEY)
stt = SpeechToTextV1(authenticator=authenticator)
stt.set_service_url(URL)

# ğŸ™ï¸ FunÃ§Ã£o para gravar Ã¡udio
def gravar_audio(duracao, arquivo):
    fs = 44100
    print("ğŸ™ï¸ Gravando...")
    audio = sd.rec(int(duracao * fs), samplerate=fs, channels=1)
    sd.wait()
    write(arquivo, fs, audio)
    print(f"âœ… GravaÃ§Ã£o salva: {arquivo}")

# ğŸ§  Reconhecimento de voz
def reconhecer_voz_ibm(arquivo):
    with open(arquivo, 'rb') as audio_file:
        resposta = stt.recognize(
            audio=audio_file,
            content_type='audio/wav',
            model='pt-BR_BroadbandModel'
        ).get_result()
    try:
        texto = resposta['results'][0]['alternatives'][0]['transcript']
        return texto
    except (IndexError, KeyError):
        return "Texto nÃ£o reconhecido"

# ğŸ’¬ DetecÃ§Ã£o de emoÃ§Ã£o
def extrair_emocao(texto):
    texto = texto.lower().strip()
    padroes_emocao = {
        'medo': ["tenho medo", "estou com medo", "assustado", "apavorado"],
        'raiva': ["estou com raiva", "nervoso", "irritado", "furioso"],
        'felicidade': ["estou feliz", "contente", "alegre", "animado"],
        'tristeza': ["estou triste", "chorando", "desanimado", "deprimido"]
    }
    for emocao, padroes in padroes_emocao.items():
        for padrao in padroes:
            if padrao in texto:
                return emocao
    return 'neutro'

# ğŸ§¾ FunÃ§Ã£o para salvar feedback se detectar errado
def salvar_feedback(texto, emocao_detectada, esperado=""):
    with open("feedback.csv", "a", newline='', encoding="utf-8") as f:
        writer = csv.writer(f)
        writer.writerow([texto, emocao_detectada, f"esperado: {esperado}"])

# ğŸ” Sistema de seguranÃ§a com anÃ¡lise
def sistema_seguranca():
    nome_arquivo = f"voz_{uuid.uuid4().hex}.wav"
    gravar_audio(5, nome_arquivo)
    
    texto = reconhecer_voz_ibm(nome_arquivo)
    emocao = extrair_emocao(texto)

    print(f"\nğŸ—£ï¸ Texto reconhecido: {texto}")
    print(f"ğŸ§  EmoÃ§Ã£o detectada: {emocao}")

    if emocao in ['medo', 'raiva']:
        print("ğŸš¨ Acesso bloqueado por risco detectado.")
    elif emocao == 'neutro':
        print("âŒ Acesso negado. EmoÃ§Ã£o nÃ£o identificada.")
        salvar_feedback(texto, emocao)
    else:
        print("âœ… Acesso liberado com seguranÃ§a.")

# â–¶ï¸ Executar
sistema_seguranca()
