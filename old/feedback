# ğŸ“¦ ImportaÃ§Ãµes
import sounddevice as sd
from scipy.io.wavfile import write
import librosa
import numpy as np
import uuid
import os
import json
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
from ibm_watson import SpeechToTextV1
from ibm_cloud_sdk_core.authenticators import IAMAuthenticator

# ğŸ”‘ IBM Watson - Substitua com a sua chave e URL
API_KEY = "sua-api-key-aqui"
URL = "sua-url-aqui"

authenticator = IAMAuthenticator(API_KEY)
stt = SpeechToTextV1(authenticator=authenticator)
stt.set_service_url(URL)

# ğŸ¤ FunÃ§Ã£o para gravar Ã¡udio
def gravar_audio(duracao, arquivo):
    fs = 44100
    print("ğŸ™ï¸ Gravando...")
    audio = sd.rec(int(duracao * fs), samplerate=fs, channels=1)
    sd.wait()
    write(arquivo, fs, audio)
    print(f"âœ… GravaÃ§Ã£o salva: {arquivo}")

# ğŸ§  TranscriÃ§Ã£o com Watson
def reconhecer_voz_ibm(arquivo):
    with open(arquivo, 'rb') as audio_file:
        resposta = stt.recognize(
            audio=audio_file,
            content_type='audio/wav',
            model='pt-BR_BroadbandModel'
        ).get_result()
    try:
        texto = resposta['results'][0]['alternatives'][0]['transcript']
        return texto
    except (IndexError, KeyError):
        return ""

# ğŸ˜  Detectar emoÃ§Ã£o por palavras-chave
def extrair_emocao(texto):
    texto = texto.lower()
    if "medo" in texto or "assustado" in texto or "pÃ¢nico" in texto:
        return "medo"
    elif "raiva" in texto or "Ã³dio" in texto or "irritado" in texto:
        return "raiva"
    elif "feliz" in texto or "alegre" in texto or "contente" in texto:
        return "alegria"
    elif "triste" in texto or "deprimido" in texto or "chorar" in texto:
        return "tristeza"
    else:
        return "neutro"

# ğŸ“ Salvar feedback
def salvar_feedback(texto, emocao_detectada, comentario):
    nova_linha = {
        "frase": texto,
        "emocao_detectada": emocao_detectada,
        "comentario": comentario
    }

    # Salvar CSV
    arquivo_csv = "feedback.csv"
    if os.path.exists(arquivo_csv):
        df = pd.read_csv(arquivo_csv)
        df = pd.concat([df, pd.DataFrame([nova_linha])], ignore_index=True)
    else:
        df = pd.DataFrame([nova_linha])
    df.to_csv(arquivo_csv, index=False)

    # Salvar JSON
    arquivo_json = "feedback.json"
    if os.path.exists(arquivo_json):
        with open(arquivo_json, 'r', encoding='utf-8') as f:
            dados = json.load(f)
    else:
        dados = []
    dados.append(nova_linha)
    with open(arquivo_json, 'w', encoding='utf-8') as f:
        json.dump(dados, f, ensure_ascii=False, indent=4)

# ğŸ“Š Mostrar grÃ¡fico
def mostrar_grafico_feedback():
    if not os.path.exists("feedback.csv"):
        print("âš ï¸ Nenhum feedback registrado ainda.")
        return

    feedback_df = pd.read_csv("feedback.csv")
    erros = feedback_df[feedback_df["comentario"] != ""]

    if erros.empty:
        print("âœ… Nenhum erro registrado atÃ© agora.")
        return

    emocao_counts = erros["emocao_detectada"].value_counts().reset_index()
    emocao_counts.columns = ["EmoÃ§Ã£o Detectada", "OcorrÃªncias"]

    plt.figure(figsize=(8, 5))
    sns.barplot(data=emocao_counts, x="EmoÃ§Ã£o Detectada", y="OcorrÃªncias")
    plt.title("FrequÃªncia de Erros por EmoÃ§Ã£o Detectada")
    plt.xlabel("EmoÃ§Ã£o com erro")
    plt.ylabel("NÃºmero de OcorrÃªncias")
    plt.tight_layout()
    plt.show()

# ğŸ” Sistema completo
def sistema_seguranca():
    nome_arquivo = f"voz_{uuid.uuid4().hex}.wav"
    gravar_audio(5, nome_arquivo)

    texto = reconhecer_voz_ibm(nome_arquivo)
    emocao = extrair_emocao(texto)

    print(f"\nğŸ—£ï¸ Texto reconhecido: {texto}")
    print(f"ğŸ§  EmoÃ§Ã£o detectada: {emocao}")

    if emocao in ["medo", "tristeza"]:
        print("âœ… Acesso autorizado.")
    else:
        print("âŒ Acesso negado.")

    # âœ”ï¸ ValidaÃ§Ã£o manual da emoÃ§Ã£o
    confirmacao = input("ğŸ” A emoÃ§Ã£o detectada estava correta? (sim/nÃ£o): ").strip().lower()
    if confirmacao != "sim":
        comentario = input("âœï¸ Qual era a emoÃ§Ã£o correta?: ").strip()
    else:
        comentario = ""

    salvar_feedback(texto, emocao, comentario)
    mostrar_grafico_feedback()

# â–¶ï¸ Rodar
sistema_seguranca()
